# 황금발판 시스템 문서

## 개요
황금발판은 윷놀이 게임에서 특별한 보너스를 제공하는 발판입니다. 말이 황금발판에 도착하면 추가로 윷을 던질 수 있는 기회를 얻습니다.

## 주요 기능

### 1. 황금발판 선택 및 표시
- 게임 시작 시 랜덤으로 황금발판이 선택됩니다 (0번 시작 위치 제외)
- 황금발판은 황금색 머티리얼로 표시됩니다
- 말이 황금발판에 도착하면 새로운 랜덤 위치로 황금발판이 이동합니다

### 2. 선택 가능한 황금발판 표시
- 윷을 던진 후 이동 가능한 발판 중 황금발판이 포함되어 있으면:
  - 황금발판은 황금색을 유지합니다
  - 황금발판 위에 빨간색 원판이 표시됩니다 (선택 가능 표시)
  - 빨간색 원판 사양:
    - 모양: Cylinder (동그란 원판)
    - 크기: X: 2.5, Y: 0.1, Z: 2.5
    - 위치: 발판 위 2.0 유닛
    - 색상: RGB(198, 36, 70, 255)

### 3. 황금발판 효과
- 말이 황금발판에 도착하면:
  1. "황금 발판 효과! 추가 던질 기회 획득!" 메시지 표시
  2. `hasExtraThrow`와 `canThrowAgain` 플래그 활성화
  3. 0.5초 대기 후 새로운 랜덤 위치에 황금발판 생성
  4. 이전 황금발판은 원래 색상으로 복구

---

## 전체 코드

### YutPlatformManager.cs (전체)

```csharp
using UnityEngine;
using System.Collections.Generic;

public class YutPlatformManager : MonoBehaviour
{
    [Header("Platform Components")]
    public Transform[] boardPositions;
    public Material goldenPlatformMaterial;
    public Material selectablePlatformMaterial;
    
    [System.NonSerialized]
    private Renderer[] platformRenderers;
    [System.NonSerialized]
    private Material[] originalMaterials;
    [System.NonSerialized]
    private int goldenPlatformIndex = -1;
    [System.NonSerialized]
    private List<int> selectablePlatformIndices = new List<int>();
    [System.NonSerialized]
    private GameObject goldenPlatformHighlight; // 황금발판 위 빨간색 표시 오브젝트
    
    public int GoldenPlatformIndex => goldenPlatformIndex;
    
    public void InitializePlatformRenderers()
    {
        if (boardPositions == null || boardPositions.Length == 0) return;
        
        platformRenderers = new Renderer[boardPositions.Length];
        originalMaterials = new Material[boardPositions.Length];
        
        for (int i = 0; i < boardPositions.Length; i++)
        {
            if (boardPositions[i] != null)
            {
                // 발판의 Renderer 찾기 (자식 객체 포함)
                platformRenderers[i] = boardPositions[i].GetComponent<Renderer>();
                if (platformRenderers[i] == null)
                {
                    platformRenderers[i] = boardPositions[i].GetComponentInChildren<Renderer>();
                }
                
                // 원본 머티리얼 저장
                if (platformRenderers[i] != null && platformRenderers[i].materials != null && platformRenderers[i].materials.Length > 0)
                {
                    originalMaterials[i] = platformRenderers[i].materials[0];
                }
                else if (platformRenderers[i] != null && platformRenderers[i].material != null)
                {
                    originalMaterials[i] = platformRenderers[i].material;
                }
            }
        }
        
        // 황금색 머티리얼 할당 확인
        if (goldenPlatformMaterial == null)
        {
            Debug.LogWarning("Golden Platform Material이 할당되지 않았습니다! Unity Inspector에서 StumpGolden 머티리얼을 할당해주세요.");
        }
    }
    
    public void SelectRandomGoldenPlatform()
    {
        if (boardPositions == null || boardPositions.Length == 0)
        {
            Debug.LogWarning("황금 발판 선택 실패: boardPositions가 null이거나 비어있습니다.");
            return;
        }
        
        // 이전 황금 발판 원래 색으로 복구
        if (goldenPlatformIndex >= 0 && goldenPlatformIndex < boardPositions.Length)
        {
            RestorePlatformColor(goldenPlatformIndex);
        }
        
        // 랜덤으로 새 황금 발판 선택 (0번 제외 - 시작 위치)
        if (boardPositions.Length > 1)
        {
            goldenPlatformIndex = Random.Range(1, boardPositions.Length);
        }
        else
        {
            goldenPlatformIndex = 0;
        }
        
        // 황금 발판으로 만들기
        MakePlatformGolden(goldenPlatformIndex);
    }
    
    public void MakePlatformGolden(int index)
    {
        if (index < 0 || index >= boardPositions.Length) return;
        if (platformRenderers == null || index >= platformRenderers.Length) return;
        if (platformRenderers[index] == null)
        {
            Debug.LogWarning($"발판 {index}에 Renderer가 없습니다!");
            return;
        }
        
        // Unity Inspector에서 할당한 황금색 머티리얼 적용
        if (goldenPlatformMaterial != null)
        {
            // materials 배열에 황금색 머티리얼 추가 또는 교체
            Material[] currentMaterials = platformRenderers[index].materials;
            
            if (currentMaterials.Length > 0)
            {
                // 첫 번째 머티리얼을 황금색으로 교체
                currentMaterials[0] = goldenPlatformMaterial;
            }
            else
            {
                // materials 배열이 비어있으면 황금색 머티리얼만 추가
                currentMaterials = new Material[] { goldenPlatformMaterial };
            }
            
            // materials 배열 적용
            platformRenderers[index].materials = currentMaterials;
        }
        else
        {
            Debug.LogError($"발판 {index}: 황금색 머티리얼이 null입니다! Unity Inspector에서 Golden Platform Material을 할당해주세요.");
        }
    }
    
    public void RestorePlatformColor(int index)
    {
        if (index < 0 || index >= boardPositions.Length) return;
        if (platformRenderers == null || index >= platformRenderers.Length) return;
        if (platformRenderers[index] == null) return;
        
        // 원본 머티리얼로 복구 (materials 배열 사용)
        if (originalMaterials[index] != null)
        {
            Material[] currentMaterials = platformRenderers[index].materials;
            
            if (currentMaterials.Length > 0)
            {
                // 첫 번째 머티리얼을 원본으로 교체
                currentMaterials[0] = originalMaterials[index];
            }
            else
            {
                // materials 배열이 비어있으면 원본 머티리얼만 추가
                currentMaterials = new Material[] { originalMaterials[index] };
            }
            
            // materials 배열 적용
            platformRenderers[index].materials = currentMaterials;
        }
        else
        {
            Debug.LogWarning($"발판 {index}의 원본 머티리얼이 null입니다!");
        }
    }
    
    public void ShowSelectablePlatforms(List<int> platformIndices)
    {
        // 기존 선택 표시 제거
        HideSelectablePlatforms();
        
        selectablePlatformIndices = new List<int>(platformIndices);
        
        if (selectablePlatformMaterial == null)
        {
            Debug.LogWarning("Selectable Platform Material이 할당되지 않았습니다!");
            return;
        }
        
        foreach (int index in platformIndices)
        {
            if (index >= 0 && index < platformRenderers.Length && platformRenderers[index] != null)
            {
                // 황금 발판은 황금색 유지하고 위에 빨간색 링 표시
                if (index == goldenPlatformIndex)
                {
                    // 황금 발판 위에 빨간색 링 생성
                    CreateGoldenPlatformHighlight(index);
                }
                else
                {
                    // 일반 발판에 하이라이트 머티리얼 적용
                    Material[] materials = new Material[platformRenderers[index].materials.Length];
                    for (int i = 0; i < materials.Length; i++)
                    {
                        materials[i] = i == 0 ? selectablePlatformMaterial : platformRenderers[index].materials[i];
                    }
                    platformRenderers[index].materials = materials;
                }
            }
        }
    }
    
    // 황금 발판 위에 빨간색 표시 생성
    private void CreateGoldenPlatformHighlight(int index)
    {
        if (boardPositions == null || index < 0 || index >= boardPositions.Length || boardPositions[index] == null)
        {
            Debug.LogWarning($"[황금발판 하이라이트] 생성 실패 - 잘못된 인덱스: {index}");
            return;
        }
        
        // 이미 존재하면 제거
        if (goldenPlatformHighlight != null)
        {
            Destroy(goldenPlatformHighlight);
        }
        
        // 빨간색 원판 생성 (Cylinder를 얇게 만들어서 동그란 원판처럼)
        goldenPlatformHighlight = GameObject.CreatePrimitive(PrimitiveType.Cylinder);
        goldenPlatformHighlight.name = "GoldenPlatformHighlight";
        goldenPlatformHighlight.layer = 0; // Default 레이어
        
        // 발판 위치보다 위로 배치
        Vector3 platformPos = boardPositions[index].position;
        goldenPlatformHighlight.transform.position = platformPos + new Vector3(0f, 2.0f, 0f); // 발판 위 2.0 유닛
        
        // 크기 조정 (넓고 얇은 원판)
        goldenPlatformHighlight.transform.localScale = new Vector3(2.5f, 0.1f, 2.5f); // 넓고 얇은 원판
        
        // RGB 색상으로 직접 머티리얼 생성 (r:198, g:36, b:70, a:255)
        Renderer highlightRenderer = goldenPlatformHighlight.GetComponent<Renderer>();
        if (highlightRenderer != null)
        {
            // 여러 셰이더 시도 (프로젝트 설정에 따라 다름)
            Shader shader = Shader.Find("Universal Render Pipeline/Lit"); // URP
            if (shader == null)
            {
                shader = Shader.Find("Standard"); // Built-in
            }
            if (shader == null)
            {
                shader = Shader.Find("Diffuse"); // Legacy
            }
            if (shader == null)
            {
                shader = Shader.Find("Unlit/Color"); // Unlit
            }
            
            if (shader != null)
            {
                // 새로운 머티리얼 생성
                Material customMaterial = new Material(shader);
                // RGB 값을 0~1 범위로 변환 (255로 나눔)
                customMaterial.color = new Color(198f / 255f, 36f / 255f, 70f / 255f, 255f / 255f);
                
                // Standard 셰이더인 경우 추가 설정
                if (shader.name.Contains("Standard"))
                {
                    customMaterial.SetFloat("_Metallic", 0f);
                    customMaterial.SetFloat("_Glossiness", 0.5f);
                }
                
                highlightRenderer.material = customMaterial;
                highlightRenderer.enabled = true;
                highlightRenderer.shadowCastingMode = UnityEngine.Rendering.ShadowCastingMode.On;
                highlightRenderer.receiveShadows = true;
                
                Debug.Log($"[황금발판 하이라이트] 커스텀 색상 적용 완료 - RGB(198, 36, 70), 셰이더: {shader.name}");
            }
            else
            {
                Debug.LogError("[황금발판 하이라이트] 사용 가능한 셰이더를 찾을 수 없습니다!");
            }
        }
        else
        {
            Debug.LogError("[황금발판 하이라이트] Renderer를 찾을 수 없습니다!");
        }
        
        // Collider 제거 (클릭 방해하지 않도록)
        Collider highlightCollider = goldenPlatformHighlight.GetComponent<Collider>();
        if (highlightCollider != null)
        {
            Destroy(highlightCollider);
        }
        
        // 오브젝트 활성화 확인
        goldenPlatformHighlight.SetActive(true);
        
        Debug.Log($"[황금발판 하이라이트] 생성 완료 - 위치: {goldenPlatformHighlight.transform.position}, 크기: {goldenPlatformHighlight.transform.localScale}, 활성화: {goldenPlatformHighlight.activeSelf}");
    }
    
    public void HideSelectablePlatforms()
    {
        foreach (int index in selectablePlatformIndices)
        {
            if (index >= 0 && index < platformRenderers.Length && platformRenderers[index] != null && originalMaterials[index] != null)
            {
                // 황금 발판은 빨간색 표시만 제거 (황금색은 유지)
                if (index == goldenPlatformIndex)
                {
                    // 빨간색 링 제거
                    if (goldenPlatformHighlight != null)
                    {
                        Destroy(goldenPlatformHighlight);
                        goldenPlatformHighlight = null;
                    }
                }
                else
                {
                    // 원본 머티리얼로 복구
                    Material[] materials = new Material[platformRenderers[index].materials.Length];
                    for (int i = 0; i < materials.Length; i++)
                    {
                        materials[i] = i == 0 ? originalMaterials[index] : platformRenderers[index].materials[i];
                    }
                    platformRenderers[index].materials = materials;
                }
            }
        }
        
        selectablePlatformIndices.Clear();
    }
    
    public bool IsPlatformSelectable(int index)
    {
        return selectablePlatformIndices.Contains(index);
    }
}
```

### YutGameManager.cs (황금발판 관련 부분)

#### 1. 초기화 (Start 메서드)
```csharp
void Start()
{
    // ... 다른 초기화 코드 ...
    
    // 발판 렌더러 초기화 (platformManager 사용)
    platformManager.InitializePlatformRenderers();
    
    // 랜덤 황금 발판 선택 (platformManager 사용)
    platformManager.SelectRandomGoldenPlatform();
    
    UpdateUI();
}
```

#### 2. MoveHorseInternal 메서드 (황금발판 체크)
```csharp
public IEnumerator MoveHorseInternal(int horseIndex, int steps)
{
    // ... 이동 로직 ...
    
    // 발판 간 이동 간격
    yield return new WaitForSeconds(0.1f);
}

// 이동 완료 후 황금 발판 체크 (최종 도착 위치에서만)
// 말이 최종 위치에 완전히 도착한 후에 황금발판 처리
if (platformManager != null && playerPositions[horseIndex] >= 0 && playerPositions[horseIndex] == platformManager.GoldenPlatformIndex)
{
    hasExtraThrow = true;
    canThrowAgain = true; // 즉시 던질 기회 제공
    platformManager.RestorePlatformColor(platformManager.GoldenPlatformIndex);
    
    // 황금 발판 효과 메시지 표시
    if (resultText != null)
    {
        resultText.text = "황금 발판 효과! 추가 던질 기회 획득!";
    }
    
    yield return new WaitForSeconds(0.5f); // 효과 확인 시간
    platformManager.SelectRandomGoldenPlatform();
}

isPlayerMoving = false;
```

#### 3. MoveToSelectedPlatformInternal 메서드 (황금발판 체크)
```csharp
public IEnumerator MoveToSelectedPlatformInternal(int horseIndex, int targetPlatformIndex, YutOutcome usedMovement = YutOutcome.Nak, bool forceGoalIn = false)
{
    // ... 이동 로직 ...
    
    yield return new WaitForSeconds(0.1f);
}

// 이동 완료 후 황금 발판 체크 (최종 도착 위치에서만)
// 말이 최종 위치에 완전히 도착한 후에 황금발판 처리
if (platformManager != null && playerPositions[horseIndex] >= 0 && playerPositions[horseIndex] == platformManager.GoldenPlatformIndex)
{
    hasExtraThrow = true;
    canThrowAgain = true; // 즉시 던질 기회 제공
    platformManager.RestorePlatformColor(platformManager.GoldenPlatformIndex);
    
    // 황금 발판 효과 메시지 표시
    if (resultText != null)
    {
        resultText.text = "황금 발판 효과! 추가 던질 기회 획득!";
    }
    
    yield return new WaitForSeconds(0.5f);
    platformManager.SelectRandomGoldenPlatform();
}

// 이동 완료
isPlayerMoving = false;

// ... 나머지 처리 ...
```

---

## 중요 사항

### 타이밍
- 황금발판 효과는 말이 **최종 위치에 완전히 도착한 후**에만 처리됩니다
- 이동 중간에는 황금발판을 체크하지 않습니다
- `MoveHorseInternal`과 `MoveToSelectedPlatformInternal` 두 메서드 모두에서 동일하게 처리됩니다

### 시각적 표현
- 황금발판은 항상 황금색을 유지합니다
- 선택 가능할 때만 위에 빨간 원판이 추가로 표시됩니다
- 일반 발판은 선택 가능할 때 완전히 빨간색으로 변경됩니다

### 셰이더 호환성
- 여러 렌더 파이프라인 지원:
  1. Universal Render Pipeline/Lit (URP)
  2. Standard (Built-in)
  3. Diffuse (Legacy)
  4. Unlit/Color (기본)
- 사용 가능한 셰이더를 순서대로 시도하여 자동 선택

### Materials 배열 처리
- Unity에서 `materials` 배열을 수정할 때는 새 배열을 생성하여 할당해야 합니다
- 기존 배열을 직접 수정하면 제대로 반영되지 않을 수 있습니다

## 디버그 로그
- `[황금발판 하이라이트] 생성 완료` - 빨간 원판 생성 성공
- `[황금발판 하이라이트] 커스텀 색상 적용 완료` - 색상 및 셰이더 적용 성공
- 위치, 크기, 활성화 상태 등 상세 정보 출력

## 설정 방법
1. Unity Inspector에서 `YutPlatformManager` 컴포넌트 찾기
2. `Golden Platform Material` 필드에 황금색 머티리얼 할당
3. `Selectable Platform Material` 필드에 빨간색 머티리얼 할당 (일반 발판용)
